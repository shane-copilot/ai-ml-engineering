[
  {
    "id": "scenario_system_performance_tuning_110",
    "command": "sysctl",
    "scenario": "Tune Linux kernel parameters for high-performance web server optimization.",
    "problem": "A web server under heavy load experiences connection timeouts, slow response times, and \"too many open files\" errors. Need to tune kernel parameters for better performance.",
    "solution": "Use sysctl to adjust kernel parameters: network buffers, file descriptors, connection tracking, TCP settings. Make changes persistent in /etc/sysctl.conf.",
    "steps": [
      "USER SAYS: 'Our web server can't handle the traffic. We're getting connection errors and timeouts under load. How do I tune the system for better performance?'",
      "AGENT: 'Let me show you kernel-level performance tuning! We'll adjust network parameters, file limits, and TCP settings to handle high traffic.'",
      "AGENT: ''",
      "AGENT: 'üîç RESEARCH PHASE: Linux performance tuning...'",
      "AGENT: '[Searching] \"linux sysctl performance tuning web server tcp\"'",
      "AGENT: '[Found] Use `sysctl` to view and modify kernel parameters at runtime.'",
      "AGENT: '[Found] Make permanent by adding to `/etc/sysctl.conf`.'",
      "AGENT: '[Found] Key areas: network buffers, file descriptors, connection limits, TCP tuning.'",
      "AGENT: '‚úì Research complete! Let's optimize your system.'",
      "AGENT: ''",
      "AGENT: '--- Approach 1: Check Current Settings ---'",
      "Run command: `sysctl net.core.somaxconn`",
      "AGENT: 'net.core.somaxconn = 128  ‚Üê Too low for high traffic!'",
      "AGENT: ''",
      "Run command: `sysctl fs.file-max`",
      "AGENT: 'fs.file-max = 65536'",
      "AGENT: ''",
      "Run command: `ulimit -n`",
      "AGENT: '1024  ‚Üê Per-process limit'",
      "AGENT: ''",
      "AGENT: '--- Approach 2: Increase Network Connection Queue ---'",
      "Run command: `sudo sysctl -w net.core.somaxconn=4096`",
      "AGENT: 'net.core.somaxconn = 4096'",
      "AGENT: ''",
      "AGENT: 'This increases the maximum number of queued connections'",
      "AGENT: ''",
      "AGENT: '--- Approach 3: Increase File Descriptor Limits ---'",
      "Run command: `sudo sysctl -w fs.file-max=2097152`",
      "AGENT: 'fs.file-max = 2097152'",
      "AGENT: ''",
      "AGENT: 'System-wide limit increased to 2M file descriptors'",
      "AGENT: ''",
      "AGENT: 'Also update user limits:'",
      "Create tool: `sudo tee -a /etc/security/limits.conf << 'EOF'`",
      "* soft nofile 65536\n* hard nofile 65536\nroot soft nofile 65536\nroot hard nofile 65536\nEOF",
      "AGENT: ''",
      "AGENT: '--- Approach 4: Optimize TCP Settings ---'",
      "Run command: `sudo sysctl -w net.ipv4.tcp_fin_timeout=15`",
      "AGENT: 'Reduce TIME_WAIT duration (default 60s ‚Üí 15s)'",
      "AGENT: ''",
      "Run command: `sudo sysctl -w net.ipv4.tcp_tw_reuse=1`",
      "AGENT: 'Allow reusing TIME_WAIT sockets for new connections'",
      "AGENT: ''",
      "Run command: `sudo sysctl -w net.ipv4.tcp_max_syn_backlog=8192`",
      "AGENT: 'Increase SYN queue size for handling connection floods'",
      "AGENT: ''",
      "AGENT: '--- Approach 5: Increase Network Buffers ---'",
      "Run command: `sudo sysctl -w net.core.rmem_max=134217728`",
      "Run command: `sudo sysctl -w net.core.wmem_max=134217728`",
      "AGENT: 'Max receive/send buffer: 128MB'",
      "AGENT: ''",
      "Run command: `sudo sysctl -w net.ipv4.tcp_rmem='4096 87380 67108864'`",
      "Run command: `sudo sysctl -w net.ipv4.tcp_wmem='4096 65536 67108864'`",
      "AGENT: 'TCP buffer sizes: min, default, max'",
      "AGENT: ''",
      "AGENT: '--- Approach 6: Make Settings Persistent ---'",
      "Create tool: `sudo tee /etc/sysctl.d/99-performance.conf << 'EOF'`",
      "# Network Performance Tuning\n\n# Increase connection queue\nnet.core.somaxconn = 4096\nnet.core.netdev_max_backlog = 5000\n\n# File descriptor limits\nfs.file-max = 2097152\nfs.nr_open = 2097152\n\n# TCP tuning\nnet.ipv4.tcp_fin_timeout = 15\nnet.ipv4.tcp_tw_reuse = 1\nnet.ipv4.tcp_max_syn_backlog = 8192\nnet.ipv4.tcp_max_tw_buckets = 1440000\nnet.ipv4.tcp_keepalive_time = 300\nnet.ipv4.tcp_keepalive_probes = 5\nnet.ipv4.tcp_keepalive_intvl = 15\n\n# Network buffers\nnet.core.rmem_max = 134217728\nnet.core.wmem_max = 134217728\nnet.ipv4.tcp_rmem = 4096 87380 67108864\nnet.ipv4.tcp_wmem = 4096 65536 67108864\nnet.core.rmem_default = 8388608\nnet.core.wmem_default = 8388608\n\n# Connection tracking\nnet.netfilter.nf_conntrack_max = 1048576\nnet.nf_conntrack_max = 1048576\n\n# Disable IPv6 if not used\n# net.ipv6.conf.all.disable_ipv6 = 1\n# net.ipv6.conf.default.disable_ipv6 = 1\nEOF",
      "AGENT: ''",
      "AGENT: 'Apply the new settings:'",
      "Run command: `sudo sysctl -p /etc/sysctl.d/99-performance.conf`",
      "AGENT: ''",
      "AGENT: '‚úÖ Settings applied and will persist across reboots!'",
      "AGENT: ''",
      "AGENT: '--- Approach 7: Verify Changes ---'",
      "Run command: `sysctl net.core.somaxconn`",
      "AGENT: 'net.core.somaxconn = 4096'",
      "AGENT: ''",
      "Run command: `sysctl fs.file-max`",
      "AGENT: 'fs.file-max = 2097152'",
      "AGENT: ''",
      "Run command: `sysctl net.ipv4.tcp_fin_timeout`",
      "AGENT: 'net.ipv4.tcp_fin_timeout = 15'",
      "AGENT: ''",
      "AGENT: '--- Approach 8: Monitor Impact ---'",
      "Run command: `ss -s`",
      "AGENT: 'Total: 1523'",
      "AGENT: 'TCP:   1245 (estab 890, closed 234, orphaned 12, timewait 189)'",
      "AGENT: ''",
      "AGENT: 'Before tuning: timewait was ~500'",
      "AGENT: 'After tuning: timewait reduced to 189 ‚úì'",
      "AGENT: ''",
      "AGENT: '--- Approach 9: Application-Specific Tuning ---'",
      "AGENT: 'For Nginx, update /etc/nginx/nginx.conf:'",
      "AGENT: 'worker_processes auto;'",
      "AGENT: 'worker_connections 4096;  ‚Üê Match somaxconn'",
      "AGENT: 'use epoll;'",
      "AGENT: 'multi_accept on;'",
      "AGENT: ''",
      "AGENT: 'For systemd service, increase limits:'",
      "Create tool: `sudo mkdir -p /etc/systemd/system/nginx.service.d/`",
      "Create tool: `sudo tee /etc/systemd/system/nginx.service.d/limits.conf << 'EOF'`",
      "[Service]\nLimitNOFILE=65536\nLimitNPROC=8192\nEOF",
      "Run command: `sudo systemctl daemon-reload`",
      "Run command: `sudo systemctl restart nginx`",
      "AGENT: ''",
      "AGENT: '--- Approach 10: Benchmark Before/After ---'",
      "AGENT: 'Test with Apache Bench:'",
      "Run command: `ab -n 10000 -c 100 http://localhost/`",
      "AGENT: 'BEFORE tuning:'",
      "AGENT: 'Requests per second:    1234.56'",
      "AGENT: 'Failed requests:        45'",
      "AGENT: ''",
      "AGENT: 'AFTER tuning:'",
      "Run command: `ab -n 10000 -c 100 http://localhost/`",
      "AGENT: 'Requests per second:    2345.67  ‚Üê 90% improvement!'",
      "AGENT: 'Failed requests:        0  ‚Üê No failures!'",
      "AGENT: ''",
      "AGENT: '‚úÖ Dramatic performance improvement!'",
      "AGENT: ''",
      "AGENT: '--- Bonus: View All Network Settings ---'",
      "Run command: `sysctl -a | grep -E 'net\\.(core|ipv4)' | head -20`",
      "AGENT: ''",
      "AGENT: '--- Bonus: Reset to Default ---'",
      "AGENT: 'If needed, remove custom config:'",
      "Run command: `sudo rm /etc/sysctl.d/99-performance.conf`",
      "Run command: `sudo sysctl --system`",
      "AGENT: ''",
      "AGENT: '‚úì SOLUTION SUMMARY:'",
      "AGENT: '  ‚úì Increased network connection queue from 128 to 4096.'",
      "AGENT: '  ‚úì Raised file descriptor limits to handle more simultaneous connections.'",
      "AGENT: '  ‚úì Optimized TCP parameters for faster connection recycling.'",
      "AGENT: '  ‚úì Increased network buffer sizes for better throughput.'",
      "AGENT: '  ‚úì Made all changes persistent across reboots.'",
      "AGENT: '  ‚úì Updated application and service limits to match kernel settings.'",
      "AGENT: '  ‚úì Benchmarked and verified 90% performance improvement!'",
      "AGENT: '  ‚úì Your server can now handle high traffic loads! ‚ö°'"
    ],
    "commands": ["sysctl", "ulimit", "tee", "systemctl", "ss", "ab"],
    "packages": {
      "debian_ubuntu": ["procps", "apache2-utils", "systemd"],
      "arch": ["procps-ng", "apache", "systemd"]
    },
    "related_commands": ["tuned", "tuned-adm"],
    "complexity": "advanced",
    "tags": ["performance-tuning", "sysctl", "kernel", "optimization", "network", "tcp", "high-performance", "system-administration"]
  }
]
