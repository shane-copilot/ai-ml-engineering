[
  {
    "id": "scenario_network_troubleshooting_116",
    "command": "ss",
    "scenario": "Diagnose network connectivity issues and analyze active connections.",
    "problem": "Application can't connect to database, users report slow network, and there are mysterious connections from unknown IPs. Need to investigate network layer comprehensively.",
    "solution": "Use ss (socket statistics) to view active connections, netstat legacy alternative, analyze listening ports, identify connection states, trace routes with traceroute, and capture packets with tcpdump.",
    "steps": [
      "USER SAYS: 'Our application can't connect to the database on port 5432. How do I figure out if it's a network issue, firewall problem, or if the service isn't listening?'",
      "AGENT: 'Let me show you comprehensive network troubleshooting! We'll check listening ports, active connections, routing, and packet flow.'",
      "AGENT: ''",
      "AGENT: 'üîç RESEARCH PHASE: Network diagnostics...'",
      "AGENT: '[Searching] \"ss netstat tcpdump network troubleshooting listening ports\"'",
      "AGENT: '[Found] `ss` is modern replacement for netstat (faster, more info).'",
      "AGENT: '[Found] Check if service listens: `ss -tuln | grep :PORT`'",
      "AGENT: '[Found] TCP connection states: LISTEN, ESTABLISHED, TIME_WAIT, etc.'",
      "AGENT: '[Found] `tcpdump` captures packets for deep analysis.'",
      "AGENT: '‚úì Research complete! Let's diagnose the network.'",
      "AGENT: ''",
      "AGENT: '--- Approach 1: Check if PostgreSQL is Listening ---'",
      "Run command: `sudo ss -tuln | grep :5432`",
      "AGENT: 'tcp   LISTEN 0      128      127.0.0.1:5432      0.0.0.0:*'",
      "AGENT: ''",
      "AGENT: 'üí° FOUND THE PROBLEM! PostgreSQL only listening on 127.0.0.1 (localhost)'",
      "AGENT: 'It should listen on 0.0.0.0 or specific external IP to accept remote connections'",
      "AGENT: ''",
      "AGENT: 'Flags explained:'",
      "AGENT: '  -t = TCP sockets'",
      "AGENT: '  -u = UDP sockets'",
      "AGENT: '  -l = Listening sockets'",
      "AGENT: '  -n = Numeric (don\\'t resolve names)'",
      "AGENT: ''",
      "AGENT: '--- Approach 2: View ALL Listening Ports ---'",
      "Run command: `sudo ss -tuln`",
      "AGENT: 'Netid State  Recv-Q Send-Q Local Address:Port  Peer Address:Port'",
      "AGENT: 'tcp   LISTEN 0      128    0.0.0.0:22          0.0.0.0:*          # SSH'",
      "AGENT: 'tcp   LISTEN 0      128    0.0.0.0:80          0.0.0.0:*          # HTTP'",
      "AGENT: 'tcp   LISTEN 0      128    0.0.0.0:443         0.0.0.0:*          # HTTPS'",
      "AGENT: 'tcp   LISTEN 0      128    127.0.0.1:5432      0.0.0.0:*          # PostgreSQL (local only!)'",
      "AGENT: 'tcp   LISTEN 0      128    127.0.0.1:6379      0.0.0.0:*          # Redis'",
      "AGENT: 'udp   UNCONN 0      0      0.0.0.0:68          0.0.0.0:*          # DHCP client'",
      "AGENT: ''",
      "AGENT: '--- Approach 3: Check Established Connections ---'",
      "Run command: `sudo ss -tnp | grep ESTAB`",
      "AGENT: 'ESTAB 0    0    192.168.1.10:22     192.168.1.100:54321  users:((\"sshd\",pid=1234))'",
      "AGENT: 'ESTAB 0    0    192.168.1.10:443    203.0.113.50:48765   users:((\"nginx\",pid=5678))'",
      "AGENT: ''",
      "AGENT: 'Flags:'",
      "AGENT: '  -p = Show process using socket'",
      "AGENT: ''",
      "AGENT: '--- Approach 4: Count Connections by State ---'",
      "Run command: `ss -tan | awk '{print $1}' | sort | uniq -c | sort -rn`",
      "AGENT: '    450 ESTAB'",
      "AGENT: '    123 TIME_WAIT'",
      "AGENT: '     45 LISTEN'",
      "AGENT: '     12 SYN-SENT'",
      "AGENT: '      5 CLOSE_WAIT'",
      "AGENT: ''",
      "AGENT: 'TCP States explained:'",
      "AGENT: '  LISTEN     = Server waiting for connections'",
      "AGENT: '  SYN-SENT   = Client attempting to connect'",
      "AGENT: '  ESTABLISHED= Active connection'",
      "AGENT: '  TIME_WAIT  = Connection closed, waiting to ensure close'",
      "AGENT: '  CLOSE_WAIT = Remote closed, local app hasn\\'t closed yet'",
      "AGENT: ''",
      "AGENT: '--- Approach 5: Find Which Process Uses Port ---'",
      "Run command: `sudo ss -tlnp | grep :80`",
      "AGENT: 'LISTEN 0 128 0.0.0.0:80  0.0.0.0:*  users:((\"nginx\",pid=5678,fd=6))'",
      "AGENT: ''",
      "Run command: `sudo lsof -i :80`",
      "AGENT: 'COMMAND  PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME'",
      "AGENT: 'nginx   5678     root    6u  IPv4  12345      0t0  TCP *:http (LISTEN)'",
      "AGENT: 'nginx   5679 www-data    6u  IPv4  12345      0t0  TCP *:http (LISTEN)'",
      "AGENT: ''",
      "AGENT: '--- Approach 6: Test Connection to Remote Port ---'",
      "Run command: `nc -zv db-server.example.com 5432`",
      "AGENT: 'Connection to db-server.example.com 5432 port [tcp/postgresql] succeeded!'",
      "AGENT: ''",
      "AGENT: 'Or test with timeout:'",
      "Run command: `timeout 5 bash -c \"</dev/tcp/db-server.example.com/5432\" && echo \"Port open\" || echo \"Port closed/filtered\"`",
      "AGENT: 'Port open'",
      "AGENT: ''",
      "AGENT: '--- Approach 7: Check Routing Table ---'",
      "Run command: `ip route show`",
      "AGENT: 'default via 192.168.1.1 dev eth0'",
      "AGENT: '192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.10'",
      "AGENT: ''",
      "Run command: `route -n`",
      "AGENT: 'Destination     Gateway         Genmask         Flags Metric Ref    Use Iface'",
      "AGENT: '0.0.0.0         192.168.1.1     0.0.0.0         UG    0      0        0 eth0'",
      "AGENT: '192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0'",
      "AGENT: ''",
      "AGENT: '--- Approach 8: Trace Route to Destination ---'",
      "Run command: `traceroute db-server.example.com`",
      "AGENT: 'traceroute to db-server.example.com (203.0.113.50), 30 hops max'",
      "AGENT: ' 1  192.168.1.1 (192.168.1.1)  1.234 ms  1.123 ms  1.056 ms'",
      "AGENT: ' 2  10.0.0.1 (10.0.0.1)  5.678 ms  5.432 ms  5.234 ms'",
      "AGENT: ' 3  198.51.100.1 (198.51.100.1)  12.345 ms  12.123 ms  12.089 ms'",
      "AGENT: ' 4  203.0.113.50 (203.0.113.50)  18.456 ms  18.234 ms  18.123 ms'",
      "AGENT: ''",
      "AGENT: 'Or TCP-based traceroute:'",
      "Run command: `traceroute -T -p 5432 db-server.example.com`",
      "AGENT: ''",
      "AGENT: '--- Approach 9: Capture Packets with tcpdump ---'",
      "Run command: `sudo tcpdump -i eth0 port 5432 -n`",
      "AGENT: 'tcpdump: listening on eth0, link-type EN10MB'",
      "AGENT: '16:30:00.123456 IP 192.168.1.10.54321 > 203.0.113.50.5432: Flags [S], seq 123456'",
      "AGENT: '16:30:00.234567 IP 203.0.113.50.5432 > 192.168.1.10.54321: Flags [S.], seq 789012, ack 123457'",
      "AGENT: '16:30:00.234789 IP 192.168.1.10.54321 > 203.0.113.50.5432: Flags [.], ack 1'",
      "AGENT: ''",
      "AGENT: '‚úÖ TCP three-way handshake successful (SYN, SYN-ACK, ACK)'",
      "AGENT: ''",
      "AGENT: 'Capture to file for analysis:'",
      "Run command: `sudo tcpdump -i eth0 port 5432 -w /tmp/postgres.pcap`",
      "AGENT: ''",
      "AGENT: 'Read capture file:'",
      "Run command: `tcpdump -r /tmp/postgres.pcap -n`",
      "AGENT: ''",
      "AGENT: '--- Approach 10: Check DNS Resolution ---'",
      "Run command: `nslookup db-server.example.com`",
      "AGENT: 'Server:         8.8.8.8'",
      "AGENT: 'Address:        8.8.8.8#53'",
      "AGENT: ''",
      "AGENT: 'Non-authoritative answer:'",
      "AGENT: 'Name:   db-server.example.com'",
      "AGENT: 'Address: 203.0.113.50'",
      "AGENT: ''",
      "Run command: `dig db-server.example.com +short`",
      "AGENT: '203.0.113.50'",
      "AGENT: ''",
      "Run command: `host db-server.example.com`",
      "AGENT: 'db-server.example.com has address 203.0.113.50'",
      "AGENT: ''",
      "AGENT: '--- Bonus: Network Interface Statistics ---'",
      "Run command: `ip -s link show eth0`",
      "AGENT: '2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500'",
      "AGENT: '    link/ether 00:11:22:33:44:55 brd ff:ff:ff:ff:ff:ff'",
      "AGENT: '    RX: bytes  packets  errors  dropped overrun mcast'",
      "AGENT: '    12345678   98765    0       0       0       0'",
      "AGENT: '    TX: bytes  packets  errors  dropped carrier collsns'",
      "AGENT: '    87654321   67890    0       0       0       0'",
      "AGENT: ''",
      "AGENT: '--- Bonus: Check Firewall Rules ---'",
      "Run command: `sudo iptables -L -n | grep 5432`",
      "Run command: `sudo ufw status | grep 5432`",
      "AGENT: ''",
      "AGENT: '--- Bonus: Bandwidth Usage ---'",
      "Run command: `sudo iftop -i eth0`",
      "AGENT: 'Shows real-time bandwidth usage per connection'",
      "AGENT: ''",
      "Run command: `nethogs eth0`",
      "AGENT: 'Shows bandwidth usage per process'",
      "AGENT: ''",
      "AGENT: '‚úì SOLUTION SUMMARY:'",
      "AGENT: '  ‚úì Found PostgreSQL only listening on localhost (not 0.0.0.0).'",
      "AGENT: '  ‚úì Checked all listening ports with ss -tuln.'",
      "AGENT: '  ‚úì Analyzed active connections and TCP states.'",
      "AGENT: '  ‚úì Identified processes using specific ports.'",
      "AGENT: '  ‚úì Tested connectivity with nc and bash TCP test.'",
      "AGENT: '  ‚úì Traced network path with traceroute.'",
      "AGENT: '  ‚úì Captured packets with tcpdump for deep analysis.'",
      "AGENT: '  ‚úì Verified DNS resolution.'",
      "AGENT: '  ‚úì You now have complete network debugging skills! üåê'"
    ],
    "commands": ["ss", "netstat", "lsof", "nc", "traceroute", "tcpdump", "ip", "route", "nslookup", "dig", "host", "iftop", "nethogs"],
    "packages": {
      "debian_ubuntu": ["iproute2", "net-tools", "netcat", "traceroute", "tcpdump", "dnsutils", "iftop", "nethogs"],
      "arch": ["iproute2", "net-tools", "gnu-netcat", "traceroute", "tcpdump", "bind-tools", "iftop", "nethogs"]
    },
    "related_commands": ["ping", "mtr", "nmap", "wireshark"],
    "complexity": "intermediate",
    "tags": ["networking", "troubleshooting", "ss", "netstat", "tcpdump", "connectivity", "diagnostics", "tcp-ip"]
  }
]
